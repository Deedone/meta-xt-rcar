From d69aa3acbe5906f79cbb0abc1ba011e43ae8a664 Mon Sep 17 00:00:00 2001
Message-Id: <d69aa3acbe5906f79cbb0abc1ba011e43ae8a664.1728817042.git.mykyta_poturai@epam.com>
From: Oleksandr Andrushchenko <oleksandr_andrushchenko@epam.com>
Date: Wed, 8 Nov 2017 10:41:00 +0200
Subject: [PATCH] virt/port/rogue: Make sure SysDevInit doesn't touch HW for
 Guest

Guest mode driver must not touch HW.

Signed-off-by: Oleksandr Andrushchenko <oleksandr_andrushchenko@epam.com>
---
 services/system/rogue/rgx_rcar/sysconfig.c | 7 +++++++
 1 file changed, 7 insertions(+)

diff --git a/services/system/rogue/rgx_rcar/sysconfig.c b/services/system/rogue/rgx_rcar/sysconfig.c
index ab6a535..abed147 100644
--- a/services/system/rogue/rgx_rcar/sysconfig.c
+++ b/services/system/rogue/rgx_rcar/sysconfig.c
@@ -298,6 +298,7 @@ static IMG_UINT32 RGX_3DGE_ClockFreqGet(IMG_HANDLE hSysData)
 {
 	SYS_DATA *psSysData = (SYS_DATA *)hSysData;
 	IMG_UINT32 rate;
+	PVRSRV_VZ_RET_IF_MODE(GUEST, RGX_3DGE_CORE_CLOCK_SPEED);
 
 	rate = (IMG_UINT32)clk_get_rate(psSysData->psRGX_FCK);
 	if (rate <= 0)
@@ -363,6 +364,7 @@ static void SetVoltage(IMG_UINT32 ui32Voltage)
 static PVRSRV_ERROR InitClocks(SYS_DATA *psSysData)
 {
 	struct platform_device *pdev = psSysData->pdev;
+	PVRSRV_VZ_RET_IF_MODE(GUEST, PVRSRV_OK);
 
 	psSysData->psRGX_FCK = devm_clk_get(&pdev->dev, NULL);
 	if (IS_ERR(psSysData->psRGX_FCK))
@@ -377,6 +379,7 @@ static PVRSRV_ERROR InitClocks(SYS_DATA *psSysData)
 static PVRSRV_ERROR DeinitClocks(SYS_DATA *psSysData)
 {
 	struct platform_device *pdev = psSysData->pdev;
+	PVRSRV_VZ_RET_IF_MODE(GUEST, PVRSRV_OK);
 
 	if (psSysData->psRGX_FCK)
 	{
@@ -393,6 +396,7 @@ static PVRSRV_ERROR EnableClocks(void)
 	struct platform_device *pdev = gpsSysData->pdev;
 	IMG_UINT32 ui32CoreClockSpeed = RGX_3DGE_CORE_CLOCK_SPEED;
 	int res;
+	PVRSRV_VZ_RET_IF_MODE(GUEST, PVRSRV_OK);
 
 	if (gpsSysData->psRGXTimingInfo && gpsSysData->psRGXTimingInfo->ui32CoreClockSpeed)
 	{
@@ -416,6 +420,7 @@ PVRSRV_ERROR DisableClocks(void)
 {
 	struct platform_device *pdev = gpsSysData->pdev;
         int res;
+	PVRSRV_VZ_RET_IF_MODE(GUEST, PVRSRV_OK);
 
         res = pm_runtime_put_sync(&pdev->dev);
         if (res < 0)
@@ -430,6 +435,7 @@ PVRSRV_ERROR DisableClocks(void)
 static PVRSRV_ERROR PMRuntimeRegister(void)
 {
 	struct platform_device *pdev = gpsSysData->pdev;
+	PVRSRV_VZ_RET_IF_MODE(GUEST, PVRSRV_OK);
 
         pm_runtime_enable(&pdev->dev);
 
@@ -439,6 +445,7 @@ static PVRSRV_ERROR PMRuntimeRegister(void)
 static PVRSRV_ERROR PMRuntimeUnregister(void)
 {
 	struct platform_device *pdev = gpsSysData->pdev;
+	PVRSRV_VZ_RET_IF_MODE(GUEST, PVRSRV_OK);
 
         pm_runtime_disable(&pdev->dev);
 
